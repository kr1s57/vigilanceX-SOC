name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository_owner }}/vigilancex-api
  IMAGE_NAME_FRONTEND: ${{ github.repository_owner }}/vigilancex-frontend
  IMAGE_NAME_DETECT2BAN: ${{ github.repository_owner }}/vigilancex-detect2ban

jobs:
  # ============================================
  # Build Backend with Garble Obfuscation
  # ============================================
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Garble
        run: go install mvdan.cc/garble@v0.12.1

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build with Garble obfuscation
        working-directory: ./backend
        run: |
          mkdir -p ../build

          # Build API with Garble obfuscation
          # Note: -tiny removed - causes "fatal: bad g in signal handler" due to
          # stripped runtime info needed for Go's signal handling
          echo "Building API with Garble..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 garble -literals -seed=random build \
            -ldflags="-w -s -X main.version=${{ steps.version.outputs.VERSION }} -X main.buildTime=$(date -u +%Y%m%d%H%M%S)" \
            -trimpath \
            -o ../build/vigilancex-api-linux-amd64 \
            ./cmd/api

          # Build Detect2Ban with Garble
          echo "Building Detect2Ban with Garble..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 garble -literals -seed=random build \
            -ldflags="-w -s -X main.version=${{ steps.version.outputs.VERSION }}" \
            -trimpath \
            -o ../build/vigilancex-detect2ban-linux-amd64 \
            ./cmd/detect2ban

          # Build reset-password tool
          echo "Building reset-password..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 garble -literals build \
            -ldflags="-w -s" \
            -trimpath \
            -o ../build/reset-password-linux-amd64 \
            ./cmd/reset-password

          # Show final binary sizes (Garble obfuscated, no UPX)
          # Note: UPX compression removed - causes "fatal: bad g in signal handler"
          # crash due to incompatibility with Go's runtime signal handling
          echo "Binary sizes (Garble obfuscated):"
          ls -lh ../build/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-binaries
          path: build/
          retention-days: 1

  # ============================================
  # Build Frontend with Terser Obfuscation
  # ============================================
  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build with obfuscation
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_BUILD_MODE: production

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 1

  # ============================================
  # Build and Push Docker Images
  # ============================================
  docker-build:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-binaries
          path: build/

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Make binaries executable
        run: chmod +x build/*

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      # Build API Image
      - name: Build and push API image
        id: build-api
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile.release
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:latest
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.description=VIGILANCE X API Server
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Frontend Image
      - name: Build and push Frontend image
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.release
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.description=VIGILANCE X Frontend
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Detect2Ban Image
      - name: Build and push Detect2Ban image
        id: build-detect2ban
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile.detect2ban.release
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_DETECT2BAN }}:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_DETECT2BAN }}:latest
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.description=VIGILANCE X Detect2Ban Engine
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Sign images with Cosign (keyless - uses GitHub OIDC)
      - name: Sign API image
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}@${{ steps.build-api.outputs.digest }}

      - name: Sign Frontend image
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}@${{ steps.build-frontend.outputs.digest }}

      - name: Sign Detect2Ban image
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_DETECT2BAN }}@${{ steps.build-detect2ban.outputs.digest }}

  # ============================================
  # Update Client Repository
  # ============================================
  update-client-repo:
    runs-on: ubuntu-latest
    needs: docker-build
    if: success()

    steps:
      - name: Checkout client repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/vigilanceX-SOC
          token: ${{ secrets.CLIENT_REPO_TOKEN }}
          path: client-repo

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update docker-compose with new version
        run: |
          cd client-repo

          # Update image tags in docker-compose.yml
          sed -i "s|ghcr.io/${{ github.repository_owner }}/vigilancex-api:.*|ghcr.io/${{ github.repository_owner }}/vigilancex-api:${{ steps.version.outputs.VERSION }}|g" deploy/docker-compose.yml
          sed -i "s|ghcr.io/${{ github.repository_owner }}/vigilancex-frontend:.*|ghcr.io/${{ github.repository_owner }}/vigilancex-frontend:${{ steps.version.outputs.VERSION }}|g" deploy/docker-compose.yml
          sed -i "s|ghcr.io/${{ github.repository_owner }}/vigilancex-detect2ban:.*|ghcr.io/${{ github.repository_owner }}/vigilancex-detect2ban:${{ steps.version.outputs.VERSION }}|g" deploy/docker-compose.yml

          # Update VERSION file if exists
          echo "${{ steps.version.outputs.VERSION }}" > VERSION

      - name: Commit and push
        run: |
          cd client-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "chore: update to v${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
          git push || echo "Nothing to push"

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    runs-on: ubuntu-latest
    needs: docker-build
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-binaries
          path: release-artifacts/

      - name: Create checksums
        run: |
          cd release-artifacts
          sha256sum * > CHECKSUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: VIGILANCE X v${{ steps.version.outputs.VERSION }}
          body: |
            ## VIGILANCE X v${{ steps.version.outputs.VERSION }}

            ### Docker Images
            ```bash
            # Pull images
            docker pull ghcr.io/${{ github.repository_owner }}/vigilancex-api:${{ steps.version.outputs.VERSION }}
            docker pull ghcr.io/${{ github.repository_owner }}/vigilancex-frontend:${{ steps.version.outputs.VERSION }}
            docker pull ghcr.io/${{ github.repository_owner }}/vigilancex-detect2ban:${{ steps.version.outputs.VERSION }}

            # Verify signatures
            cosign verify ghcr.io/${{ github.repository_owner }}/vigilancex-api:${{ steps.version.outputs.VERSION }}
            ```

            ### Client Repository
            For deployment instructions, see: https://github.com/${{ github.repository_owner }}/vigilanceX-SOC

            ### Security
            - Binaries obfuscated with Garble
            - Docker images signed with Cosign
          files: |
            release-artifacts/*
          draft: false
          prerelease: false
